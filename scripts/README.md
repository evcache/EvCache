# Scripts

This directory contains helper scripts used by the project.

## Python virtual environment

This step is taken care of if you run the `build.sh` script to set things up. Below are instructions
for manual setup of this venv.

Some scripts require additional Python packages for graphing (E.g. `-G` mode in `vset`). To set up a
local environment:
```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```
Run these commands inside the `scripts` directory.

After activation, build the binaries and run tools from the `build/` directory; e.g.:
```bash
cd build
sudo ./vset -u 16 -f 4 -o 64 -M 10 -G 2
```

As already mentioned, the build script (`scripts/build.sh`) will also create the virtual
environment and install the requirements automatically.

## `setup_vset.sh`

`vset` needs to move itself to a high‑priority cgroup. Run the script before use (once is enough).
```bash
sudo ./scripts/setup_vset.sh
```

The cgroups are cleared on reboot, so rerun the script after each restart.

## Graphing

The Python utilities in this folder consume data generated by `vset` 
and produce figures using the Py scripts. These scripts are automatically
called by e.g. `vset` once they write the data, though one can manully reproduce 
them using the help menus (shown below).

> [!NOTE]  
> The graphs in the paper are generated with `gnuplot` and appear in a  
> more polished form. The Python scripts included here are earlier  
> testing versions. They are integrated into EvCache’s utilities,  
> accept parameters (e.g. data files), and are automatically invoked by  
> tools such as `vset`. The corresponding `gnuplot` versions will  
> be included once they are able to accept inputs generated at runtime  
> and automatically produce graphs in the same way as the Python  
> scripts. At that point, they will replace the Python versions and  
> generate the graphs identical to those in the paper.

If you want to use a graphing mode of vset (`-G <0|1|2|3|4>`), make sure to activate the 
virtual environment set up by the `build.sh` script by doing:
```bash
source venv/bin/activate
```
under the `scripts/` directory.


And prepend your `vset` command with `--preserve-env=HOME,PATH`, such as:
```bash
sudo --preserve-env=HOME,PATH ./vset --activity-freq -G 0
```

in order to prevent errors like `unable to find xyz` libraries used to generate the graphs (e.g. matplotlib),
as they are accessible through the user's PATH, but not found when running `vset` with `sudo`.

### `plot_evrate_over_time.py`

```bash
python scripts/plot_evrate_over_time.py -i "file1.csv label1" "file2.csv label2" -o 80
```

Help:
```bash
python scripts/plot_evrate_over_time.py -h
usage: plot_evrate_over_time.py [-h] -i I [I ...] [-o OPACITY] [--separate]

Plot EWMA eviction rates over time

options:
  -h, --help    show this help message and exit
  -i I [I ...]  comma-separated list of "path label" pairs
  -o OPACITY    line opacity percentage (0-100)
  --separate    generate individual PDFs for each input file
```

### `plot_eviction_rate_wait.py`

```bash
python scripts/plot_eviction_rate_wait.py results.csv -o evrate.pdf
```

Help:
```bash
python scripts/plot_eviction_rate_wait.py -h
usage: plot_eviction_rate_wait.py [-h] [-o OUTPUT] file

Plot eviction rate vs wait time

positional arguments:
  file                  data file generated by vset

options:
  -h, --help            show this help message and exit
  -o OUTPUT, --output OUTPUT
                        output PDF file
```

### `plot_l2color_heatmap.py`

```bash
python scripts/plot_l2color_heatmap.py data.csv --no-grid
```

Help:
```bash
python scripts/plot_l2color_heatmap.py -h
usage: plot_l2color_heatmap.py [-h] [-o OUTPUT] [--no-colorbar] [--no-grid] [--no-line] [--rise-speed RISE_SPEED]
                               [--fall-stickiness FALL_STICKINESS] [--max-jump MAX_JUMP] [--asymmetry ASYMMETRY]
                               [--heatmap-color {1,2}]
                               input_file

Generate L2 color heatmap from vset data

positional arguments:
  input_file            Input data file from vset -G 2

options:
  -h, --help            show this help message and exit
  -o OUTPUT, --output OUTPUT
                        Output file prefix (default: derived from input filename)
  --no-colorbar, -nc    Disable colorbar in the heatmap
  --no-grid, -ng        Disable grid lines in the heatmap
  --no-line, -nl        Disable EWMA lines overlay
  --rise-speed RISE_SPEED, -rs RISE_SPEED
                        Weight for rises (0-1, higher = faster rises, default: 0.3)
  --fall-stickiness FALL_STICKINESS, --fs FALL_STICKINESS, -fs FALL_STICKINESS
                        Weight for falls (0-1, lower = stickier falls, default: 0.01)
  --max-jump MAX_JUMP, -mj MAX_JUMP
                        Maximum single-step increase to prevent sudden spikes (default: 0.15)
  --asymmetry ASYMMETRY, -a ASYMMETRY
                        Asymmetry factor: higher values make rises faster and falls stickier (default: 2.0)
  --heatmap-color {1,2}, -hc {1,2}
                        Heatmap color scheme: 1=colorful, 2=grayscale (default: 1)
```

